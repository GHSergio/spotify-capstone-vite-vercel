<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <meta charset="UTF-8" />
    <script type="text/javascript">
      window.addEventListener("DOMContentLoaded", (event) => {
        // 檢查是否有重定向路徑
        var redirectPath = localStorage.getItem("redirectPath");
        if (redirectPath) {
          // 清除重定向路徑
          localStorage.removeItem("redirectPath");
          // 重定向到原始路徑
          window.history.replaceState({}, document.title, redirectPath);
          // 根據路徑執行相應邏輯，例如調用回調函數
          handlePath(redirectPath);
        }
      });

      function handlePath(path) {
        // 根據路徑執行相應邏輯，例如處理授權回調
        if (path.startsWith("/vite-vercel-phi-seven.vercel.app/callback")) {
          // 執行回調邏輯
          handleSpotifyCallback();
        }
      }

      function handleSpotifyCallback() {
        // 獲取 URL 中的參數
        var params = new URLSearchParams(window.location.search);
        var accessToken = params.get("access_token");
        // 假設這裡有你的後端 API URL
        var apiURL = REACT_APP_SPOTIFY_API_BASE_URI;

        // 使用 fetch 獲取數據並存儲到 localStorage
        fetch(apiURL, {
          headers: {
            Authorization: "Bearer " + accessToken,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            localStorage.setItem("spotifyData", JSON.stringify(data));
            // 完成後重定向到 main 頁面
            window.location.replace(
              "/vite-vercel-phi-seven.vercel.app/main.html"
            );
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    </script>
    <title>Alpha capstone</title>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://open.spotify.com/embed/iframe-api/v1" async></script>
    <div id="spotify-player">
      <script type="text/javascript"></script>
    </div>
  </body>
</html>
